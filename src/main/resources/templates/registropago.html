<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro de Pago | CodiPlayCo</title>
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="stylesheet" th:href="@{/assets/estilosregistropago.css}" />
</head>
<body>
  <main>
    <form id="form-registro">
      <label>Nombre</label>
      <input id="nombre" required />

      <label>Email</label>
      <input id="email" type="email" required />

      <label>Curso</label>
      <input id="curso" th:value="${curso.curso}" disabled />

      <label>Telefono</label>
      <input id="telefono" required />

      <input type="hidden" id="cursoId" th:value="${curso.id}" />
      <input type="hidden" id="cursoNombre" th:value="${curso.curso}" />
      <input type="hidden" id="cursoPrecio" th:value="${curso.precio}" />

      <button type="submit">Registrar e ir al Pago</button>
    </form>
  </main>

  <!-- modal -->
  <div id="modal-metodo-pago" style="display:none;">
    <div>
      <button id="cerrar-modal-metodo">Cerrar</button>
      <h3>Resumen</h3>
      <p>Producto: <span id="producto"></span></p>
      <p>Valor: $<span id="precio"></span></p>

      <div id="card-element"></div>
      <div id="card-errors" role="alert" style="color:#c00"></div>

      <button id="payButton">Pagar ahora</button>
    </div>
  </div>

  <script>
    (function(){
      const stripe = Stripe("pk_test_51SX7JBPq4mgnIKbVAOWyqzo4vG9fVH87XgZhJcxs8BUZl2Z8r7wWnPWnlsQzY7QxKaA41FNaHLXZeuJWxIBHAegA00tHKCkZjT"); // reemplaza por tu pk pública
      let clientSecret = null;
      let card = null;
      let cardMounted = false;
      let registroId = null;
      let registropagoId = null;

      const modal = document.getElementById("modal-metodo-pago");

      document.getElementById("form-registro").addEventListener("submit", async (e) => {
        e.preventDefault();
        // 1) Guardar registro
        const registro = {
          nombre: document.getElementById("nombre").value,
          email: document.getElementById("email").value,
          telefono: document.getElementById("telefono").value,
          cursoId: parseInt(document.getElementById("cursoId").value),
          cursoNombre: document.getElementById("cursoNombre").value,
          precio: parseInt(document.getElementById("cursoPrecio").value),
          estadoPago: "pendiente"
        };

        const res = await fetch('/api/registro/guardar', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(registro)
        });

        const regData = await res.json();
        registroId = regData.id; // id del registro (registro_pago)
        registropagoId = registroId;

        // 2) Abrir modal y crear PaymentIntent
        document.getElementById("producto").innerText = registro.cursoNombre;
        document.getElementById("precio").innerText = registro.precio;
        modal.style.display = "block";

        // build PaymentRequest DTO for backend
        const paymentReq = {
          precio: registro.precio,
          currency: "cop",
          description: registro.cursoNombre,
          nombre: registro.nombre,
          email: registro.email,
          telefono: registro.telefono
          // amount will be set server-side from precio->centavos, but PaymentRequest setPrecio does it clientside too
        };

        // create payment intent
        const res2 = await fetch('/api/payments/create-payment-intent', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(paymentReq)
        });

        const intentData = await res2.json();
        if (intentData.error) {
          document.getElementById("card-errors").innerText = intentData.error;
          return;
        }

        clientSecret = intentData.clientSecret;

        // montar Stripe card element solo una vez
        if (!cardMounted) {
          const elements = stripe.elements();
          card = elements.create('card');
          card.mount('#card-element');

          card.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
              displayError.textContent = event.error.message;
            } else {
              displayError.textContent = '';
            }
          });

          cardMounted = true;
        }
      });

      document.getElementById('cerrar-modal-metodo').addEventListener('click', ()=> {
        modal.style.display = 'none';
      });

      document.getElementById('payButton').addEventListener('click', async () => {
        document.getElementById('payButton').disabled = true;
        document.getElementById('card-errors').innerText = '';

        if (!clientSecret) {
          document.getElementById('card-errors').innerText = 'Error: no se creó el pago. Intenta de nuevo.';
          document.getElementById('payButton').disabled = false;
          return;
        }

        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card }
        });

        if (error) {
          document.getElementById('card-errors').innerText = error.message;
          document.getElementById('payButton').disabled = false;
          return;
        }

        if (paymentIntent && paymentIntent.status === 'succeeded') {
          // Guardar en BD mediante /api/payments/confirm
          const pago = {
            precio: parseInt(document.getElementById("cursoPrecio").value),
            stripePaymentId: paymentIntent.id,
            estado: paymentIntent.status
          };

          const res = await fetch('/api/payments/confirm?registroId=' + registropagoId, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(pago)
          });

          const confirmData = await res.json();
          // redirigir según resultado
          if (confirmData.status === 'success') {
            window.location.href = '/payment-success';
          } else {
            window.location.href = '/payment-failed';
          }
        } else {
          document.getElementById('card-errors').innerText = 'Pago no completado.';
          document.getElementById('payButton').disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
